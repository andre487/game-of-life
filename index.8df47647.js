const t=i();class e extends Error{constructor(t){super(t),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}function i(){return Object.create(null)}function s(t){try{t()}catch(t){window.reportError(t)}}function n(t,...e){setTimeout(()=>t(...e),0)}function o(t){return function(e){!function(t,e=Error){throw new e(t)}(e,t)}}function l(t,e,i){let s=t;return s<e&&(s=e),s>i&&(s=i),s}function a(t,e){let i=BigInt(t)-BigInt(e);return i>0n?1:i<0n?-1:0}function h(t,e){let i=[],s=null;function n(){try{t(i)}catch(t){window.reportError(t)}i=[],s=null}return function(t){i.push(t),s||(s=setTimeout(n,e))}}const r=new Intl.NumberFormat(globalThis?.navigator?.language??"en-US");(S=T||(T={})).Stopped="Stopped",S.Running="Running",S.Stopping="Stopping",S.Completed="Completed";class _{constructor(t){this._stopFlag=!1,this._startCallbacks=[],this._stopCallbacks=[],this._roundCallbacks=[],this._state=T.Stopped,this._roundStartTime=0,this._runRoundAsync=t=>{this._roundStartTime=Date.now();let e=this._lifeMap.getLifeLocalities(),s=i();for(let[t,n]of e){let e=this._lifeMap.isAlive(t,n),o=0;for(let e=t-1n;e<=t+1n;++e)for(let i=n-1n;i<=n+1n;++i)e===t&&i===n||(o+=this._lifeMap.isAlive(e,i)?1:0);e&&!(2===o||3===o)?(s[t.toString()]??=i())[n.toString()]=!1:e||3!==o||((s[t.toString()]??=i())[n.toString()]=!0)}t(s)},this._lifeMap=t}get state(){return this._state}onStart(t){this._startCallbacks.push(t)}onStop(t){this._stopCallbacks.push(t)}onRound(t){this._roundCallbacks.push(t)}stop(){this._stopFlag=!0,this._state=T.Stopping}run(){let e=e=>{let o=!1;for(let[i,s]of Object.entries(e))for(let[e,n]of Object.entries(s??t))this._lifeMap.isAlive(i,e,n??!1),o=!0;n(()=>{this._roundCallbacks.forEach(s)}),o?this._stopFlag?(this._state=T.Stopped,n(()=>{this._stopCallbacks.forEach(s)})):i():(this._state=T.Completed,n(()=>{this._stopCallbacks.forEach(s)}))},i=()=>{setTimeout(()=>this._runRoundAsync(e),_.ROUND_TIME-(Date.now()-this._roundStartTime))};this._stopFlag=!1,this._roundStartTime=Date.now(),i(),this._state=T.Running,n(()=>{this._startCallbacks.forEach(s)})}}_.ROUND_TIME=250;class c{constructor(t){this._mapView=t}removeSave(t=c.BUTTON_SAVE_NAME){delete localStorage[t]}save(t=c.BUTTON_SAVE_NAME){window.localStorage[t]=this._mapView.getSaveString()}load(t=c.BUTTON_SAVE_NAME){if(this.doesSaveExist(t)){let e=window.localStorage[t];this._mapView.loadSaveFromString(e)}}doesSaveExist(t=c.BUTTON_SAVE_NAME){return!!window.localStorage[t]}}c.BUTTON_SAVE_NAME="save",c.AUTO_SAVE_NAME="auto_save";const d=o(class extends e{});class u{constructor(t){this._disableAutosave=!1,this._lifeMap=t.lifeMap,this._mapView=t.mapView,this._game=t.game,this._saveGameController=t.saveGameController,this._messagesView=t.messagesView,this._startButton=document.getElementById("start")??d("Button not found"),this._stopButton=document.getElementById("stop")??d("Button not found"),this._centerButton=document.getElementById("center")??d("Button not found"),this._noZoomButton=document.getElementById("no-zoom")??d("Button not found"),this._saveButton=document.getElementById("save")??d("Button not found"),this._loadButton=document.getElementById("load")??d("Button not found"),this._resetButton=document.getElementById("reset")??d("Button not found"),this._helpShowButton=document.getElementById("help-button")??d("Button not found"),this._helpCloseButton=document.getElementById("help__close")??d("Button not found"),this._helpBlock=document.getElementById("help")??d("Help not found")}init(){window.addEventListener("click",t=>{t.target!==this._resetButton&&(this._disableAutosave=!1)}),this._game.onStart(()=>{this._startButton.setAttribute("disabled",""),this._stopButton.removeAttribute("disabled"),this._loadButton.setAttribute("disabled",""),this._resetButton.setAttribute("disabled","")}),this._game.onStop(()=>{this._stopButton.setAttribute("disabled",""),this._startButton.removeAttribute("disabled"),this._saveGameController.doesSaveExist()&&this._loadButton.removeAttribute("disabled"),this._game.state===T.Completed&&this._messagesView.showMessage("The game is completed!"),this._resetButton.removeAttribute("disabled")}),this._startButton.onclick=()=>{this._game.run()},this._stopButton.onclick=()=>{this._game.stop()},this._centerButton.onclick=()=>{this._mapView.moveToCenter()},this._noZoomButton.onclick=()=>{this._mapView.resetCellsSize()},this._saveButton.onclick=()=>{this._saveGameController.save()},this._loadButton.onclick=()=>{this._saveGameController.load()},this._saveGameController.doesSaveExist()&&(this._loadButton.removeAttribute("disabled"),this._messagesView.showMessage("You have a saved game")),this._resetButton.onclick=()=>{this._disableAutosave=!0,this._saveGameController.removeSave(c.AUTO_SAVE_NAME),window.location.reload()},this._helpShowButton.onclick=()=>{this._helpBlock.classList.remove("help_hidden")},this._helpCloseButton.onclick=()=>{this._helpBlock.classList.add("help_hidden")},window.addEventListener("beforeunload",()=>{this._disableAutosave||this._saveGameController.save(c.AUTO_SAVE_NAME)}),this._saveGameController.doesSaveExist(c.AUTO_SAVE_NAME)&&this._saveGameController.load(c.AUTO_SAVE_NAME)}}let m=2n**20n;window.location.href.search(/[?&]huge-universe=1(?:&|$)/)>-1&&(m=2n**64n);class f extends e{}function g(t,e){return a(t[0],e[0])||a(t[1],e[1])}class p{constructor(t=m,e=m){this._container=i(),this._width=0n,this._height=0n,this._minX=0n,this._maxX=0n,this._minY=0n,this._maxY=0n,this._changeListeners=[],this._width=BigInt(t),this._height=BigInt(e),this.reset()}static stringifySaveData(t){return t.join(";")}static parseSaveString(t){return t.split(";")}get width(){return this._width}get height(){return this._height}get populatedRect(){return{left:this._minX,right:this._maxX,top:this._minY,bottom:this._maxY}}get container(){return this._container}isAlive(t,e,i){if(t=BigInt(t),e=BigInt(e),t<0n||t>=this._width||e<0n||e>=this._height)return!1;void 0!==i&&this._setStatusToContainer(t,e,i);let s=t.toString(),n=e.toString();return!!this._container[s]?.[n]}getLifeLocalities(){let t=[],e=new Map,i=this._container,s=this._width,n=this._height;for(let o in i){let l=BigInt(o);for(let a in i[o]){let i=BigInt(a);for(let o=l-1n;o<=l+1n;++o)for(let l=i-1n;l<=i+1n;++l){if(e.get(o)?.has(l)===!0||o<0n||o>=s||l<0n||l>=n)continue;let i=e.get(o);i||(i=new Set,e.set(o,i)),i.add(l),t.push([o,l])}}}return t.sort(g)}addChangeListener(t){-1===this._changeListeners.indexOf(t)&&this._changeListeners.push(t)}reset(){this._container=i(),this._minX=this._height-1n,this._maxX=0n,this._minY=this._width-1n,this._maxY=0n,this._changeListeners.forEach(s)}getSaveData(){let e=[this._width,this._height,this._minX,this._maxX,this._minY,this._maxY],i=[];for(let[e,s]of Object.entries(this._container))i.push(`${e}:${Object.keys(s??t).join(",")}`);return e.push(i.join("|")),e}loadSaveData(t){if(t.length<7)throw new f("Invalid save data length");this._width=BigInt(t[0]),this._height=BigInt(t[1]),this._minX=BigInt(t[2]),this._maxX=BigInt(t[3]),this._minY=BigInt(t[4]),this._maxY=BigInt(t[5]);let e=this._container=i();for(let s of t[6].split("|")){let[t,n]=s.split(":");if(!t||!n)continue;let o=e[t]=i();for(let t of n.split(","))o[t]=!0}}_setStatusToContainer(e,s,n){let o=e.toString(),l=s.toString();n?(this._container[o]??=i())[l]=!0:!n&&this._container[o]&&(delete this._container[o]?.[l],0===Object.keys(this._container[o]??t).length&&delete this._container[o]),n&&(e-p.POPULATED_DELTA<this._minX&&(this._minX=e-p.POPULATED_DELTA,this._minX<0n&&(this._minX=0n)),e+p.POPULATED_DELTA>this._maxX&&(this._maxX=e+p.POPULATED_DELTA,this._maxX>=this._width&&(this._maxX=this._width-1n)),s-p.POPULATED_DELTA<this._minY&&(this._minY=s-p.POPULATED_DELTA,this._minY<0n&&(this._minY=0n)),s+p.POPULATED_DELTA>=this._maxY&&(this._maxY=s+p.POPULATED_DELTA,this._maxY>=this._height&&(this._maxY=this._height-1n)))}}p.POPULATED_DELTA=30n;let E=!1;try{window.matchMedia("(prefers-color-scheme: dark)").matches&&(E=!0)}catch(t){window.reportError(t)}let w="#616161",v="#bdbdbd",B="#fafafa";E&&(w="#bdbdbd",v="#616161",B="#000000");var L,S,T,I,M={gridFill:w,gridStroke:v,gridBorderColor:B};class A extends e{}const C=o(A);(L=I||(I={})).Initial="Initial",L.Rendered="Rendered",L.Input="Input";class y{constructor(t){this._state=I.Initial,this._cellWidth=y.DEFAULT_CELL_WIDTH,this._cellHeight=y.DEFAULT_CELL_HEIGHT,this._cellsByHorizontal=0,this._cellsByVertical=0,this._cellsHorizontalOffset=0n,this._cellsVerticalOffset=0n,this._curFrameRequest=null,this.render=()=>{this._ctx.clearRect(0,0,this._canvasWidth,this._canvasHeight);let t=this._cellsVerticalOffset,e=t+BigInt(this._cellsByVertical);for(;t<=e;++t){let e=this._cellsHorizontalOffset,i=e+BigInt(this._cellsByHorizontal);for(;e<=i;++e)this._setCellState(t,e,this._lifeMap.isAlive(t,e))}this._state!==I.Input&&(this._state=I.Rendered),this._xValue.innerHTML=r.format(this._cellsVerticalOffset),this._yValue.innerHTML=r.format(this._cellsHorizontalOffset);let i=this._lifeMap.populatedRect;this._popWidth.innerHTML=r.format(l(i.right-i.left,0n,this._lifeMap.width)),this._popHeight.innerHTML=r.format(l(i.bottom-i.top,0n,this._lifeMap.height))},this.moveBy=(t,e)=>{this._cellsHorizontalOffset=l(this._cellsHorizontalOffset+t,0n,this._lifeMap.width),this._cellsVerticalOffset=l(this._cellsVerticalOffset+e,0n,this._lifeMap.height),this.renderWhenFrame()},this.moveToCenter=()=>{this._setCenterOffsets(),this.renderWhenFrame()},this.renderWhenFrame=()=>{this._curFrameRequest||(this._curFrameRequest=requestAnimationFrame(()=>{this._curFrameRequest=null,this.render()}))},this.beginInput=()=>{if(this._state!==I.Rendered)throw Error("Input is not available");this._state=I.Input,this._canvas.addEventListener("click",this._inputListener)},this.endInput=()=>{if(this._state!==I.Input)throw new A("Input is not available");this._state=I.Rendered,this._canvas.removeEventListener("click",this._inputListener)},this._inputListener=t=>{if(this._state!==I.Input)throw new A("The map not into INPUT state");let e=this._getCellByClientCoordinates(t.clientX,t.clientY);this._toggleCellState(e.top,e.left)},this._lifeMap=t,this._canvas=document.getElementById("map")??C("Canvas not found"),this._canvasRect=this._canvas.getBoundingClientRect(),this._canvasWidth=this._canvas.clientWidth,this._canvasHeight=this._canvas.clientHeight,this._ctx=this._canvas.getContext("2d")??C("Failed to create context"),this._ctx.fillStyle=M.gridFill,this._ctx.strokeStyle=M.gridStroke,this._xValue=document.getElementById("map-params__item-x")??C("No X value"),this._yValue=document.getElementById("map-params__item-y")??C("No Y value"),this._popWidth=document.getElementById("map-params__item-populated-width")??C("No pop width value"),this._popHeight=document.getElementById("map-params__item-populated-height")??C("No pop width value"),this._initMapData(),this._lifeMap.addChangeListener(()=>{this._initMapData(),this.renderWhenFrame()}),new O(this)}get canvas(){return this._canvas}get cellWidth(){return this._cellWidth}get cellHeight(){return this._cellHeight}getSaveString(){let t=this._lifeMap.getSaveData();return t.push(this._cellWidth,this._cellHeight,this._cellsHorizontalOffset,this._cellsVerticalOffset),p.stringifySaveData(t)}loadSaveFromString(t){let e=p.parseSaveString(t);if(this._lifeMap.loadSaveData(e),e.length<11)return this._initMapData(),this.renderWhenFrame();this._cellWidth=parseInt(e[7])||y.DEFAULT_CELL_WIDTH,this._cellHeight=parseInt(e[8])||y.DEFAULT_CELL_HEIGHT,this._initMapData(!1);try{this._cellsHorizontalOffset=BigInt(e[9]),this._cellsVerticalOffset=BigInt(e[10])}catch(t){window.reportError(t),this._setCenterOffsets()}this.renderWhenFrame()}resizeCellsBy(t){let e=Math.trunc(t),i=this._cellWidth+e,s=this._cellHeight+e;this.setCellsSizes(i,s)}resetCellsSize(){this.setCellsSizes(y.DEFAULT_CELL_WIDTH,y.DEFAULT_CELL_HEIGHT)}setCellsSizes(t,e){let i=!1;if(this._cellWidth!==t&&t>=y.MIN_CELL_SIZE&&t<=y.MAX_CELL_SIZE&&(this._cellWidth=t,i=!0),this._cellHeight!==e&&e>=y.MIN_CELL_SIZE&&e<=y.MAX_CELL_SIZE&&(this._cellHeight=e,i=!0),i){let t=this._cellsHorizontalOffset+BigInt(this._cellsByHorizontal)/2n,e=this._cellsVerticalOffset+BigInt(this._cellsByVertical)/2n;this._initMapData(),this._cellsHorizontalOffset=t-BigInt(this._cellsByHorizontal)/2n,this._cellsVerticalOffset=e-BigInt(this._cellsByVertical)/2n,this.renderWhenFrame()}}_initMapData(t=!0){if(this._cellsByHorizontal=Math.floor(this._canvasWidth/this._cellWidth),this._cellsByHorizontal>this._lifeMap.width)throw new A("Map width is too low");if(this._cellsByVertical=Math.floor(this._canvasHeight/this._cellHeight),this._cellsByVertical>this._lifeMap.height)throw new A("Map height is too low");t&&this._setCenterOffsets()}_setCenterOffsets(){this._cellsHorizontalOffset=(this._lifeMap.width-BigInt(this._cellsByHorizontal))/2n,this._cellsVerticalOffset=(this._lifeMap.height-BigInt(this._cellsByVertical))/2n}_getCellByClientCoordinates(t,e){let i=BigInt(Math.trunc((e-this._canvasRect.top)/this._cellHeight)),s=BigInt(Math.trunc((t-this._canvasRect.left)/this._cellWidth));return{top:this._cellsVerticalOffset+i,left:this._cellsHorizontalOffset+s}}_toggleCellState(t,e){let i=!this._lifeMap.isAlive(t,e);this._setCellState(t,e,i)}_setCellState(t,e,i){this._lifeMap.isAlive(t,e,i);let s=Number(e-this._cellsHorizontalOffset)*this._cellWidth,n=Number(t-this._cellsVerticalOffset)*this._cellHeight,o=this._ctx;if(i){o.fillRect(s,n,this._cellWidth,this._cellHeight);let t=o.strokeStyle;o.strokeStyle=M.gridBorderColor,o.strokeRect(s,n,this._cellWidth,this._cellHeight),o.strokeStyle=t}else o.clearRect(s,n,this._cellWidth,this._cellHeight),o.strokeRect(s,n,this._cellWidth,this._cellHeight)}}y.DEFAULT_CELL_WIDTH=12,y.DEFAULT_CELL_HEIGHT=12,y.MIN_CELL_SIZE=5,y.MAX_CELL_SIZE=22;class O{constructor(t){this._pointerLocked=!1,this._onScroll=t=>{let e=0,i=0;for(let s of t)s.metaKey||s.ctrlKey||(e+=s.deltaX,i+=s.deltaY);if(!e&&!i)return;let s=BigInt(Math.trunc(e/this._mapView.cellWidth)),n=BigInt(Math.trunc(i/this._mapView.cellHeight));(s||n)&&this._mapView.moveBy(s,n)},this._onKey=t=>{if(!this._pointerLocked)return;let e=0,i=0,s=!1;for(let n of t){let t=O.KEY_ACTIONS[n.code];switch(t){case"up":i+=1;break;case"left":e+=1;break;case"down":i-=1;break;case"right":e-=1}t&&(n.metaKey||n.ctrlKey)&&(s=!0)}if(s&&(e||i)){let t=e;Math.abs(i)>Math.abs(e)&&(t=i),t=Math.round(t),this._mapView.resizeCellsBy(-t);return}(e||i)&&this._mapView.moveBy(BigInt(e),BigInt(i))},this._onZoom=t=>{let e=0,i=0;for(let s of t)(s.metaKey||s.ctrlKey)&&(e-=s.deltaX,i-=s.deltaY);if(!e&&!i)return;let s=e;Math.abs(i)>Math.abs(e)&&(s=i),s=Math.round(s/10),this._mapView.resizeCellsBy(s)},this._lockPointer=()=>{this._pointerLocked=!0},this._unlockPointer=()=>{this._pointerLocked=!1},this._defaultPreventer=t=>{if(!this._pointerLocked)return;let e=t instanceof KeyboardEvent,i=t instanceof MouseEvent;(e||i)&&(t.shiftKey||t.altKey)||e&&(t.ctrlKey||t.metaKey)&&("Digit0"===t.code||"Minus"===t.code||"Equal"===t.code)||t.preventDefault()},this._mapView=t,this._onScrollThrottled=h(this._onScroll,O.SCROLL_TIMEOUT),this._onZoomThrottled=h(this._onZoom,O.ZOOM_TIMEOUT),this._onKeyThrottled=h(this._onKey,O.KEY_TIMEOUT);let e=this._mapView.canvas;e.addEventListener("mousewheel",this._onScrollThrottled),e.addEventListener("mousewheel",this._onZoomThrottled),e.addEventListener("mouseenter",this._lockPointer),e.addEventListener("mouseleave",this._unlockPointer),e.addEventListener("mousewheel",this._defaultPreventer),window.addEventListener("keydown",this._onKeyThrottled),window.addEventListener("keydown",this._defaultPreventer)}}O.SCROLL_TIMEOUT=32,O.KEY_TIMEOUT=16,O.ZOOM_TIMEOUT=75,O.KEY_ACTIONS={KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",__proto__:null};class b{constructor(){this._container=document.createElement("div"),this._container.className="messages-container",document.body.appendChild(this._container)}showMessage(t,e){e=e??"info";let i=document.createElement("div"),s=document.createElement("span");i.classList.add("message"),i.classList.add(e),i.innerHTML=t,s.className="close",s.innerHTML="&times;",i.appendChild(s),this._container.appendChild(i);let n=()=>{this._container.removeChild(i),s.onclick=null},o=setTimeout(n,b.LIFE_TIME);s.onclick=function(){return clearTimeout(o),n(),!1}}showError(t){this.showMessage(t,"error")}bindToErrors(){window.addEventListener("error",t=>{t.filename.startsWith("chrome")||this.showError(`An error has occurred: ${t.error}`)}),window.addEventListener("unhandledrejection",t=>{this.showError(`An error has occurred: ${t.reason}`)})}}b.LIFE_TIME=1e4,function(t){function e(){n(t),document.removeEventListener("DOMContentLoaded",e),window.removeEventListener("load",e)}if("interactive"===document.readyState||"complete"===document.readyState)return e();document.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e)}(function(){let t=new b;t.bindToErrors();let e=new p,i=new y(e),s=new _(e),n=new c(i),o=new u({lifeMap:e,mapView:i,game:s,saveGameController:n,messagesView:t});s.onStart(i.endInput),s.onStop(i.beginInput),s.onRound(i.renderWhenFrame),i.render(),i.beginInput(),o.init(),console.log("Game is ready!"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{window.location.reload()})});
//# sourceMappingURL=index.8df47647.js.map
