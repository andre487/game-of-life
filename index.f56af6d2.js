var t,e,i,s;class n extends Error{constructor(t){super(t),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}function o(){return Object.create(null)}function h(t){try{t()}catch(t){window.reportError(t)}}function l(t,...e){setTimeout(()=>t(...e),0)}function a(t){return function(e){!function(t,e=Error){throw new e(t)}(e,t)}}function r(t,e){let i=BigInt(t),s=BigInt(e);return i<0n?i=s+i:i>=s&&(i%=s),i}function _(t,e,i){let s=t;return s<e&&(s=e),s>i&&(s=i),s}function c(t,e){let i=[],s=null;function n(){try{t(i)}catch(t){window.reportError(t)}i=[],s=null}return function(t){i.push(t),s||(s=setTimeout(n,e))}}const d=new Intl.NumberFormat(navigator.language);(i=t||(t={})).Stopped="Stopped",i.Running="Running",i.Stopping="Stopping",i.Completed="Completed";class u{constructor(e){this._stopFlag=!1,this._startCallbacks=[],this._stopCallbacks=[],this._roundCallbacks=[],this._state=t.Stopped,this._roundStartTime=0,this._runRoundAsync=t=>{this._roundStartTime=Date.now();let e=this._lifeMap.populatedRect,i=o();for(let t=e.top;t<=e.bottom;++t)for(let s=e.left;s<=e.right;++s){let e=this._lifeMap.isAlive(t,s),n=0;for(let e=-1;e<=1;++e)for(let i=-1;i<=1;++i)if(!(0===e&&0===i)){let o=t+BigInt(e),h=s+BigInt(i);n+=this._lifeMap.isAlive(o,h)?1:0}let h=t.toString(),l=s.toString();e&&!(2===n||3===n)?(i[h]??=o(),i[h][l]=!1):e||3!==n||(i[h]??=o(),i[h][l]=!0)}t(i)},this._lifeMap=e}get state(){return this._state}onStart(t){this._startCallbacks.push(t)}onStop(t){this._stopCallbacks.push(t)}onRound(t){this._roundCallbacks.push(t)}stop(){this._stopFlag=!0,this._state=t.Stopping}run(){let e=e=>{let s=!1;for(let[t,i]of Object.entries(e))for(let[e,n]of Object.entries(i))this._lifeMap.isAlive(t,e,n),s=!0;l(()=>{this._roundCallbacks.forEach(h)}),s?this._stopFlag?(this._state=t.Stopped,l(()=>{this._stopCallbacks.forEach(h)})):i():(this._state=t.Completed,l(()=>{this._stopCallbacks.forEach(h)}))},i=()=>{setTimeout(()=>this._runRoundAsync(e),u.ROUND_TIME-(Date.now()-this._roundStartTime))};this._stopFlag=!1,this._roundStartTime=Date.now(),i(),this._state=t.Running,l(()=>{this._startCallbacks.forEach(h)})}}u.ROUND_TIME=250;const m=a(class extends n{});class p{constructor(t){this._lifeMap=t.lifeMap,this._mapView=t.mapView,this._game=t.game,this._saveGameController=t.saveGameController,this._messagesView=t.messagesView,this._startButton=document.getElementById("start")??m("Button not found"),this._stopButton=document.getElementById("stop")??m("Button not found"),this._centerButton=document.getElementById("center")??m("Button not found"),this._noZoomButton=document.getElementById("no-zoom")??m("Button not found"),this._saveButton=document.getElementById("save")??m("Button not found"),this._loadButton=document.getElementById("load")??m("Button not found"),this._resetButton=document.getElementById("reset")??m("Button not found"),this._helpShowButton=document.getElementById("help-button")??m("Button not found"),this._helpCloseButton=document.getElementById("help__close")??m("Button not found"),this._helpBlock=document.getElementById("help")??m("Help not found")}init(){this._game.onStart(()=>{this._startButton.setAttribute("disabled",""),this._stopButton.removeAttribute("disabled"),this._loadButton.setAttribute("disabled",""),this._resetButton.setAttribute("disabled","")}),this._game.onStop(()=>{this._stopButton.setAttribute("disabled",""),this._startButton.removeAttribute("disabled"),this._saveGameController.doesSaveExist()&&this._loadButton.removeAttribute("disabled"),this._game.state===t.Completed&&this._messagesView.showMessage("The game is completed!"),this._resetButton.removeAttribute("disabled")}),this._startButton.onclick=()=>{this._game.run()},this._stopButton.onclick=()=>{this._game.stop()},this._centerButton.onclick=()=>{this._mapView.moveToCenter()},this._noZoomButton.onclick=()=>{this._mapView.resetCellsSize()},this._saveButton.onclick=()=>{this._saveGameController.save()},this._loadButton.onclick=()=>{this._saveGameController.load()},this._saveGameController.doesSaveExist()&&(this._loadButton.removeAttribute("disabled"),this._messagesView.showMessage("You have a saved game")),this._resetButton.onclick=()=>{this._lifeMap.reset(),this._mapView.renderWhenFrame()},this._helpShowButton.onclick=()=>{this._helpBlock.classList.remove("help_hidden")},this._helpCloseButton.onclick=()=>{this._helpBlock.classList.add("help_hidden")}}}class f extends n{}class g{constructor(t,e){this._container=o(),this._width=0n,this._height=0n,this._minX=0n,this._maxX=0n,this._minY=0n,this._maxY=0n,this._changeListeners=[],this._width=BigInt(t),this._height=BigInt(e),this.reset()}get width(){return this._width}get height(){return this._height}get populatedRect(){return{left:this._minX,right:this._maxX,top:this._minY,bottom:this._maxY}}get container(){return this._container}isAlive(t,e,i){let s=r(t,this._width),n=r(e,this._height);void 0!==i&&this._setStatusToContainer(s,n,i);let o=s.toString(),h=n.toString();return!!this._container[o]?.[h]}addChangeListener(t){-1===this._changeListeners.indexOf(t)&&this._changeListeners.push(t)}reset(){this._container=o(),this._minX=this._height-1n,this._maxX=0n,this._minY=this._width-1n,this._maxY=0n,this._changeListeners.forEach(h)}serialize(){let t=[this._width,this._height,this._minX,this._maxX,this._minY,this._maxY],e=[];for(let[t,i]of Object.entries(this._container))e.push(`${t}:${Object.keys(i).join(",")}`);return t.push(e.join("|")),t.join(";")}loadSerializedState(t){let e=t.split(";");if(e.length<7)throw new f("Invalid save data length");this._width=BigInt(e[0]),this._height=BigInt(e[1]),this._minX=BigInt(e[2]),this._maxX=BigInt(e[3]),this._minY=BigInt(e[4]),this._maxY=BigInt(e[5]);let i=this._container=o();for(let t of e[6].split("|")){let[e,s]=t.split(":");for(let t of(i[e]=o(),s.split(",")))i[e][t]=!0}this._changeListeners.forEach(h)}_setStatusToContainer(t,e,i){if(t>=this._width||t<0n||e>=this._height||e<0n)return;let s=t.toString(),n=e.toString();i?(this._container[s]??=o(),this._container[s][n]=!0):!i&&this._container[s]&&(delete this._container[s][n],0===Object.keys(this._container[s]).length&&delete this._container[s]),i&&(t-g.POPULATED_DELTA<this._minX&&(this._minX=t-g.POPULATED_DELTA,this._minX<0n&&(this._minX=0n)),t+g.POPULATED_DELTA>this._maxX&&(this._maxX=t+g.POPULATED_DELTA,this._maxX>=this._width&&(this._maxX=this._width-1n)),e-g.POPULATED_DELTA<this._minY&&(this._minY=e-g.POPULATED_DELTA,this._minY<0n&&(this._minY=0n)),e+g.POPULATED_DELTA>=this._maxY&&(this._maxY=e+g.POPULATED_DELTA,this._maxY>=this._height&&(this._maxY=this._height-1n)))}}g.POPULATED_DELTA=30n;const E=window.getComputedStyle(document.body),w=E.getPropertyValue("--dark-background")??"#e6e6fa",v=E.getPropertyValue("--default-color")??"#708090";class L extends n{}const B=a(L);(s=e||(e={})).Initial="Initial",s.Rendered="Rendered",s.Input="Input";class I{constructor(t){this._state=e.Initial,this._cellWidth=I.DEFAULT_CELL_WIDTH,this._cellHeight=I.DEFAULT_CELL_HEIGHT,this._cellsByHorizontal=0,this._cellsByVertical=0,this._cellsHorizontalOffset=0n,this._cellsVerticalOffset=0n,this._curFrameRequest=null,this.render=()=>{this._ctx.clearRect(0,0,this._canvasWidth,this._canvasHeight);let t=this._cellsVerticalOffset,i=t+BigInt(this._cellsByVertical);for(;t<i;++t){let e=this._cellsHorizontalOffset,i=e+BigInt(this._cellsByHorizontal);for(;e<i;++e)this._setCellState(t,e,this._lifeMap.isAlive(t,e))}this._state!==e.Input&&(this._state=e.Rendered),this._xValue.innerHTML=d.format(this._cellsVerticalOffset),this._yValue.innerHTML=d.format(this._cellsHorizontalOffset);let s=this._lifeMap.populatedRect;this._popWidth.innerHTML=d.format(_(s.right-s.left,0n,this._lifeMap.width)),this._popHeight.innerHTML=d.format(_(s.bottom-s.top,0n,this._lifeMap.height))},this.moveBy=(t,e)=>{this._cellsHorizontalOffset=_(this._cellsHorizontalOffset+t,0n,this._lifeMap.width),this._cellsVerticalOffset=_(this._cellsVerticalOffset+e,0n,this._lifeMap.height),this.renderWhenFrame()},this.moveToCenter=()=>{this._setCenterOffsets(),this.renderWhenFrame()},this.renderWhenFrame=()=>{this._curFrameRequest||(this._curFrameRequest=requestAnimationFrame(()=>{this._curFrameRequest=null,this.render()}))},this.beginInput=()=>{if(this._state!==e.Rendered)throw Error("Input is not available");this._state=e.Input,this._canvas.addEventListener("click",this._inputListener)},this.endInput=()=>{if(this._state!==e.Input)throw new L("Input is not available");this._state=e.Rendered,this._canvas.removeEventListener("click",this._inputListener)},this._inputListener=t=>{if(this._state!==e.Input)throw new L("The map not into INPUT state");let i=this._getCellByClientCoordinates(t.clientX,t.clientY);this._toggleCellState(i.top,i.left)},this._lifeMap=t,this._canvas=document.getElementById("map")??B("Canvas not found"),this._canvasRect=this._canvas.getBoundingClientRect(),this._canvasWidth=this._canvas.clientWidth,this._canvasHeight=this._canvas.clientHeight,this._ctx=this._canvas.getContext("2d")??B("Failed to create context"),this._ctx.fillStyle=v,this._ctx.strokeStyle=w,this._xValue=document.getElementById("map-params__item-x")??B("No X value"),this._yValue=document.getElementById("map-params__item-y")??B("No Y value"),this._popWidth=document.getElementById("map-params__item-populated-width")??B("No pop width value"),this._popHeight=document.getElementById("map-params__item-populated-height")??B("No pop width value"),this._initMapData(),this._lifeMap.addChangeListener(()=>{this._initMapData(),this.render()}),new T(this)}get canvas(){return this._canvas}get cellWidth(){return this._cellWidth}get cellHeight(){return this._cellHeight}resizeCellsBy(t){let e=Math.trunc(t),i=this._cellWidth+e,s=this._cellHeight+e;this.setCellsSizes(i,s)}resetCellsSize(){this.setCellsSizes(I.DEFAULT_CELL_WIDTH,I.DEFAULT_CELL_HEIGHT)}setCellsSizes(t,e){let i=!1;this._cellWidth!==t&&t>=I.MIN_CELL_SIZE&&t<=I.MAX_CELL_SIZE&&(this._cellWidth=t,i=!0),this._cellHeight!==e&&e>=I.MIN_CELL_SIZE&&e<=I.MAX_CELL_SIZE&&(this._cellHeight=e,i=!0),i&&(this._initMapData(),this.renderWhenFrame())}_initMapData(){if(this._cellsByHorizontal=Math.floor(this._canvasWidth/this._cellWidth),this._cellsByHorizontal>this._lifeMap.width)throw new L("Map width is too low");if(this._cellsByVertical=Math.floor(this._canvasHeight/this._cellHeight),this._cellsByVertical>this._lifeMap.height)throw new L("Map height is too low");this._setCenterOffsets()}_setCenterOffsets(){this._cellsHorizontalOffset=(this._lifeMap.width-BigInt(this._cellsByHorizontal))/2n,this._cellsVerticalOffset=(this._lifeMap.height-BigInt(this._cellsByVertical))/2n}_getCellByClientCoordinates(t,e){let i=BigInt(Math.trunc((e-this._canvasRect.top)/this._cellHeight)),s=BigInt(Math.trunc((t-this._canvasRect.left)/this._cellWidth));return{top:this._cellsVerticalOffset+i,left:this._cellsHorizontalOffset+s}}_toggleCellState(t,e){let i=!this._lifeMap.isAlive(t,e);this._setCellState(t,e,i)}_setCellState(t,e,i){this._lifeMap.isAlive(t,e,i);let s=Number(e-this._cellsHorizontalOffset)*this._cellWidth,n=Number(t-this._cellsVerticalOffset)*this._cellHeight;i?this._ctx.fillRect(s,n,this._cellWidth,this._cellHeight):(this._ctx.clearRect(s,n,this._cellWidth,this._cellHeight),this._ctx.strokeRect(s,n,this._cellWidth,this._cellHeight))}}I.DEFAULT_CELL_WIDTH=10,I.DEFAULT_CELL_HEIGHT=10,I.MIN_CELL_SIZE=3,I.MAX_CELL_SIZE=20;class T{constructor(t){this._pointerLocked=!1,this._onScroll=t=>{let e=0,i=0;for(let s of t)s.metaKey||s.ctrlKey||(e+=s.deltaX,i+=s.deltaY);if(!e&&!i)return;let s=BigInt(Math.trunc(e/this._mapView.cellWidth)),n=BigInt(Math.trunc(i/this._mapView.cellHeight));(s||n)&&this._mapView.moveBy(s,n)},this._onKey=t=>{if(!this._pointerLocked)return;let e=0,i=0,s=!1;for(let n of t){let t=T.KEY_ACTIONS[n.code];switch(t){case"up":i+=1;break;case"left":e+=1;break;case"down":i-=1;break;case"right":e-=1}t&&(n.metaKey||n.ctrlKey)&&(s=!0)}if(s&&(e||i)){let t=e;Math.abs(i)>Math.abs(e)&&(t=i),t=Math.round(t),this._mapView.resizeCellsBy(-t);return}(e||i)&&this._mapView.moveBy(BigInt(e),BigInt(i))},this._onZoom=t=>{let e=0,i=0;for(let s of t)(s.metaKey||s.ctrlKey)&&(e-=s.deltaX,i-=s.deltaY);if(!e&&!i)return;let s=e;Math.abs(i)>Math.abs(e)&&(s=i),s=Math.round(s/10),this._mapView.resizeCellsBy(s)},this._lockPointer=()=>{this._pointerLocked=!0},this._unlockPointer=()=>{this._pointerLocked=!1},this._defaultPreventer=t=>{if(!this._pointerLocked)return;let e=t instanceof KeyboardEvent,i=t instanceof MouseEvent;(e||i)&&(t.shiftKey||t.altKey)||e&&(t.ctrlKey||t.metaKey)&&("Digit0"===t.code||"Minus"===t.code||"Equal"===t.code)||t.preventDefault()},this._mapView=t,this._onScrollThrottled=c(this._onScroll,T.SCROLL_TIMEOUT),this._onZoomThrottled=c(this._onZoom,T.ZOOM_TIMEOUT),this._onKeyThrottled=c(this._onKey,T.KEY_TIMEOUT);let e=this._mapView.canvas;e.addEventListener("mousewheel",this._onScrollThrottled),e.addEventListener("mousewheel",this._onZoomThrottled),e.addEventListener("mouseenter",this._lockPointer),e.addEventListener("mouseleave",this._unlockPointer),e.addEventListener("mousewheel",this._defaultPreventer),window.addEventListener("keydown",this._onKeyThrottled),window.addEventListener("keydown",this._defaultPreventer)}}T.SCROLL_TIMEOUT=32,T.KEY_TIMEOUT=16,T.ZOOM_TIMEOUT=75,T.KEY_ACTIONS={KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",__proto__:null};class C{constructor(){this._container=document.createElement("div"),this._container.className="messages-container",document.body.appendChild(this._container)}showMessage(t,e){e=e??"info";let i=document.createElement("div"),s=document.createElement("span");i.classList.add("message"),i.classList.add(e),i.innerHTML=t,s.className="close",s.innerHTML="&times;",i.appendChild(s),this._container.appendChild(i);let n=()=>{this._container.removeChild(i),s.onclick=null},o=setTimeout(n,C.LIFE_TIME);s.onclick=function(){return clearTimeout(o),n(),!1}}showError(t){this.showMessage(t,"error")}bindToErrors(){window.addEventListener("error",t=>{t.filename.startsWith("chrome")||this.showError(`An error has occurred: ${t.error}`)}),window.addEventListener("unhandledrejection",t=>{this.showError(`An error has occurred: ${t.reason}`)})}}C.LIFE_TIME=1e4;class M{constructor(t){this._lifeMap=t}save(){window.localStorage.save=this._lifeMap.serialize()}load(){if(this.doesSaveExist()){let t=window.localStorage.save;this._lifeMap.loadSerializedState(t)}}doesSaveExist(){return!!window.localStorage.save}}!function(t){function e(){l(t),document.removeEventListener("DOMContentLoaded",e),window.removeEventListener("load",e)}if("interactive"===document.readyState||"complete"===document.readyState)return e();document.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e)}(function(){let t=new C;t.bindToErrors();let e=new g(1024n,1024n),i=new I(e),s=new u(e),n=new M(e),o=new p({lifeMap:e,mapView:i,game:s,saveGameController:n,messagesView:t});s.onStart(i.endInput),s.onStop(i.beginInput),s.onRound(i.renderWhenFrame),i.render(),i.beginInput(),o.init(),console.log("Game is ready!")});
//# sourceMappingURL=index.f56af6d2.js.map
